#!/bin/bash

# Step 1: Get user input for the IP address
read -p "Please enter the IP address to scan: " ip
echo

# Step 2: Run Nmap scan
echo "Running Nmap scan on $ip..."
nmap_output="output.txt"
sudo nmap -sSV $ip -T4 -oG $nmap_output
echo

# Step 3: Extract version information from the Nmap output and store it in version.txt
egrep -v "^#|Status: Up" $nmap_output | cut -d' ' -f4- |
    sed -n -e 's/Ignored.*//p' | tr ',' '\n' | sed -e 's/^[ \t]*//' |
    sort -n | uniq -c | sort -k 1 -r | head -n 10 |
    awk -F'//' '{print $NF}' |
    sed -e 's/ (.*)//g' -e 's/[\/ ]*$//' | sed '/^$/d' >version.txt

echo "version.txt ================================"
cat version.txt
echo "============================================"
echo

# Step 4: Iterate through each line in version.txt, remove trailing backslashes, and search in Metasploit
while IFS= read -r version; do
    # Remove any trailing backslashes
    clean_version=$(echo "$version" | sed 's/[\/ ]*$//')

    # Start Metasploit and search for the cleaned version
    echo "Starting Metasploit and searching for $clean_version..."
    msfconsole -q -x "search $clean_version; exit"
    echo "============================================"
    echo "Starting searchsploit and searching for $clean_version..."
    searchsploit $clean_version
    echo "============================================"
    echo
done <version.txt

echo
echo "=============== End of script =============="
